<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>車位抽籤</title>
  <meta content="" name="description">
  <meta content="" name="keywords">
  <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">  
  <link rel="stylesheet" type="text/css" href="./css/editor.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="./css/buttons.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="./css/select.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="./css/dataTables.dateTime.min.css">
  <link rel="stylesheet" type="text/css" href="./css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="./css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="./css/bootstrap-icons.min.css">

  <link rel="stylesheet" type="text/css" href='./css/quill.bubble.min.css'>
  <link rel="stylesheet" type="text/css" href='./css/quill.snow.min.css'>

  <link rel="stylesheet" type="text/css" href="./css/style.min.css" >
  <link  rel="stylesheet" type="text/css" href="./css/toastr.min.css"  />

  <script type="text/javascript" src="./js/vue.min.js"></script>

  <script type="text/javascript" src="./js/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="./js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="./js/jquery.dataTables.min.js"></script> 
  <script type="text/javascript" src="./js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="./js/buttons.bootstrap5.min.js"></script>
  <script type="text/javascript" src="./js/dataTables.select.min.js"></script>
  <script type="text/javascript" src="./js/dataTables.dateTime.min.js"></script> 
  <script type="text/javascript" src="./js/jszip.min.js"></script>
  <script type="text/javascript" src="./js/pdfmake.min.js"></script>
  <script type="text/javascript" src="./js/vfs_fonts.min.js"></script>
  <script type="text/javascript" src="./js/buttons.html5.min.js"></script>
  <script type="text/javascript" src="./js/buttons.print.min.js"></script>

  <script type="text/javascript" src="./js/dataTables.editor.min.js" ></script>
  <script type="text/javascript" src="./js/editor.bootstrap5.min.js"></script>
  <script type="text/javascript" src="./js/editor-demo.min.js"></script> 
  
  <script src="./js/xlsx.full.min.js"></script>
  <script src="./js/toastr.min.js"></script>

  <style>
    .bi::before, [class^="bi-"]::before, [class*=" bi-"]::before {
      display: inline-block;
      font-family: bootstrap-icons !important;
      font-style: normal;
      font-weight: normal !important;
      font-variant: normal;
      text-transform: none;
      line-height: 1;
      vertical-align: -0.125em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .dataTables_wrapper{
      padding: 0 5px;
    }

    .dataTables_wrapper .dataTables_length label,.dataTables_wrapper .dataTables_filter label,
    .dataTables_wrapper .dataTables_filter,.dataTables_wrapper .dataTables_filter input{
      width: 100% !important;
    }
    
    .dataTables_wrapper .dataTables_length label,.dataTables_wrapper .dataTables_filter label{
      padding: 1px 8px;
      border: 1px solid #aaa;
      border-radius:15px;
    }
    .dataTables_wrapper .dataTables_length select{
      border: none;
    }
    .dataTables_wrapper .dataTables_filter input{
      margin-left: 0;
      border: none;
    }
    .dataTables_wrapper .dataTables_filter input:hover{
      border: none;
    }
    .dataTables_wrapper .dataTables_paginate{
      padding-top: 0.555rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button{
      padding: 0 8px;
      border-radius:10px;
    }
    .dataTables_wrapper .dataTables_paginate .ellipsis {
      padding: 0 1px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{
      background: #f6f9ff;
      color: #012970;
      order: 1px solid #012970;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover,.dataTables_wrapper .dataTables_paginate .paginate_button:hover{
      background: #012970;
      color: #f6f9ff !important;
      order: 1px solid #012970;
    }

    tbody .btn.editor-delete ,tbody .btn.editor-edit  {
      margin: 0 5px;
      padding: 3px 6px;
      margin: 0;
    }

    .editor-create,tbody .editor-edit.btn{ background: #012970 !important; }

    tbody .editor-delete.btn{ background: #a12b2b !important;}

    .editor-upload{background: #446db5 !important;}

    .editor-view{ background: #ca6630 !important;}

    .editor-create:hover,tbody .editor-edit.btn:hover,
    .editor-create:active,tbody .editor-edit.btn:active
    { background: #2153a9 !important; }

    tbody .editor-delete.btn:hover,tbody .editor-delete.btn:active{ background: #ba3b3b !important;}

    .editor-upload:hover,.editor-upload:active{ background: #153d83 !important;}
    .editor-view:hover,.editor-view:active{ background:#8c4722 !important;}

    .ambition_item{
      padding: 1px 5px;
      margin:3px;
      border: 1px solid #153d83;
      border-radius: 8px;
      font-size:10px;
      color: #153d83;
    }

    .uploadFile_block #HomeUploadFile,.uploadFile_block button{
      font-size: 12px;
    }

    @media (max-width: 900px) {

      .dataTables_wrapper .dataTable-top,
      .dataTables_wrapper .dataTable-bottom{
        align-items: center;
      }

      .dataTables_wrapper .dataTable-bottom div:first-child,
      .dataTables_wrapper .dataTable-bottom nav{
        width: 100% !important;
      }
      div.dt-buttons{
        width: 100% !important;
        margin-bottom: .5rem !important;
      }
      .dataTables_wrapper .dataTables_filter{
        margin-top: 0;
      }
      .dataTables_wrapper .dataTables_info{
        padding-top: 6px;
      }
      .dataTables_wrapper .dataTables_paginate{
        padding-top: 0;
      }
    }

  </style>
</head>

<body>
  <div id="web_block">
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center"> <div class="d-flex align-items-center justify-content-between"> <a href="#" class="logo d-flex align-items-center"> <span class="d-none d-lg-block">{{user.last_name}}{{user.first_name}}</span> </a> <i class="bi bi-list toggle-sidebar-btn"></i> </div></header>
    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar"> <ul class="sidebar-nav" id="sidebar-nav"> <li class="nav-item" v-for="(item,index) in menu"> <div v-if="item.header !== '' " class="nav-heading">Pages</div> <a class="nav-link" :class="item.href == pageCont.breadcrumb ? '' :'collapsed' " v-on:click="clickMenu(item.href)"> <i class="bi" :class="item.icon"></i> <span>{{item.name}}</span> </a> </li> </ul></aside><!-- End Sidebar-->
    <main id="main" class="main">
      <div class="pagetitle"><h1>{{pageCont.name}}</h1><nav> <ol class="breadcrumb"> <div v-for="(item,index) in pageCont.breadcrumb_" class="breadcrumb-item d-flex" :class="{ active : (index+1) == pageCont.breadcrumb_.length  ? true : false }"> <li class="breadcrumb-item">{{item}}</li> </div> </ol></nav></div> <!-- End Page Title -->
      <section class="section dashboard"> </section>
    </main><!-- End #main -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer"> <div class="copyright"> &copy; {{user.last_name}} <strong><span> {{user.first_name}}</span></strong>. All Rights Reserved </div> </footer><!-- End Footer -->

  </div>

  <script>
    var editor;
    var parking = localStorage.getItem('parkingData');
    var resident = localStorage.getItem('residentData');
    let HomeBody_Code_ ;
    toastr.options = { closeButton: false,  debug: false,  newestOnTop: false,  progressBar: true,  positionClass: "toast-top-right", preventDuplicates: false,  onclick: null,  showDuration: "200",  hideDuration: "1000", timeOut: "3000",  extendedTimeOut: "3000",  showEasing: "swing",  hideEasing: "linear",  showMethod: "fadeIn",  hideMethod: "fadeOut" };
    const mt = { pageCont:{ name:'Home', breadcrumb:'Home/Home', breadcrumb_:['Home','Home'] }, user:{ last_name :'Brchen', first_name:'0507', }, menu:[ { header:'', icon:'bi-collection-fill', name:'Home', href:"Home/Home" }, { header:'Pages', icon:'bi-app-indicator', name:'車位資訊', href:"Pages/車位資訊" }, { header:'', icon:'bi-card-heading', name:'住戶資訊', href:"Pages/住戶資訊"} ], parkingData: parking !==null? JSON.parse(parking):[], residentData: resident !==null? JSON.parse(resident):[]};
    const datatables_Language ={ decimal: "", emptyTable: "表中無可用數據!!", info: '顯示  _PAGE_ ~ _PAGES_ 頁 (共: _TOTAL_ 筆)', infoEmpty: '查無資料...', infoFiltered: '(共: _MAX_ 筆)', infoPostFix:  "", thousands: ",", lengthMenu: '_MENU_', loadingRecords: "Loading...", processing: "", search: "", searchPlaceholder: "收尋關鍵字", zeroRecords: 'sorry 查無資料...', paginate: { first: "首頁", last: "頁尾", next: "下一頁", previous: "上一頁" }, aria: { "sortAscending":  ": 激活以對列升序排序", "sortDescending": ": 激活以對列進行降序排序" } };
    const residentCont = {
      idsrc:'DT_RowId',
      fields:[ 
        { label:"戶別:", name: "tobe" },
        { label:"姓名:", name: "name" }, 
        { label:"電話:", name: "phone" }, 
        { label:"車牌:", name: "license"}, 
        { label:"門禁卡號:", name: "card_num"},
        { label:"車格號:", name: "lattice_num" },
        { label:'意願(8個|*請用,隔開):', name: 'ambitions'}
      ],
      columns:[
        { 
          data: null ,orderable: false, render: ( d,r,i,n )=>{
            let ambitions = '';
            const ambitions_ = d.ambitions.split(',');
            for(a in ambitions_){ ambitions += `<div class='ambition_item float-start'>${ambitions_[a]}</div>` };
            return `
              <h2 class="accordion-header" id="heading_${d.DT_RowId}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_${d.DT_RowId}" aria-expanded="false" aria-controls="collapse_${d.DT_RowId}">${d.tobe} / ${d.name}</button>
              </h2>
              <div id="collapse_${d.DT_RowId}" class="accordion-collapse collapse" aria-labelledby="heading_${d.DT_RowId}" data-bs-parent="#accordionBody">
                <div class="accordion-body profile">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">資料明細</h6>
                    <div class="d-flex justify-content-between align-items-center" > 
                      <span class="editor-edit text-white btn btn-sm mx-2"> <i class="bi bi-pen-fill"></i> </span> 
                      <span class="editor-delete text-white btn btn-sm"> <i class="bi bi-trash2-fill"></i></span> 
                    </div>
                  </div>
                  <div class="profile-overview row px-2">
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">戶別:</div>
                      <div class="col-lg-6 col-md-8">${d.tobe}</div>
                    </div>
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">姓名:</div>
                      <div class="col-lg-6 col-md-8">${d.name}</div>
                    </div>
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">電話:</div>
                      <div class="col-lg-6 col-md-8">${d.phone}</div>
                    </div>
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">車牌:</div>
                      <div class="col-lg-6 col-md-8">${d.license}</div>
                    </div>
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">門禁卡號:</div>
                      <div class="col-lg-6 col-md-8">${d.card_num}</div>
                    </div>
                    <div class="row col-lg-4 m-0 mb-1 p-0">
                      <div class="col-lg-4 col-md-4 label">車格號:</div>
                      <div class="col-lg-6 col-md-8">${d.lattice_num}</div>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="w-30 label me-2">意願-${ambitions_.length}(8個): </div>
                      <div class="">${ambitions}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          },
          className:'accordion-item p-0'
        },
      ]
    };
    const parkingCont = {
      idsrc:'DT_RowId',
      fields:[ 
        { label:"區塊:", name: "block" },
        { label:"樓層:", name: "floor" }, 
        { label:"車格號(請用,隔開):", name: "grids" },
        { label:"已抽中-ID(請用,隔開):", name: "grideds" }
      ],
      columns:[
        { 
          data: null ,orderable: false, render: ( d,r,i,n )=>{
            let grid='';
            let grided='';
            const grids = d.grids == '' ? [] : d.grids.split(',');
            const grideds = d.grideds == '' ? [] : d.grideds.split(',');

            for(a in grids){ grid += `<div class='ambition_item float-start'>${grids[a]}</div>` };
            for(a in grideds){ grided += `<div class='ambition_item float-start'>${grideds[a]}</div>` };

            return `
              <h2 class="accordion-header" id="heading_${d.DT_RowId}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_${d.DT_RowId}" aria-expanded="false" aria-controls="collapse_${d.DT_RowId}">
                  ${d.block}區 / ${d.floor } 樓
                </button>
              </h2>
              <div id="collapse_${d.DT_RowId}" class="accordion-collapse collapse" aria-labelledby="heading_${d.DT_RowId}" data-bs-parent="#accordionBody">
                <div class="accordion-body profile">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">資料明細</h6>
                    <div class="d-flex justify-content-between align-items-center" > 
                      <span class="editor-edit text-white btn btn-sm mx-2"> <i class="bi bi-pen-fill"></i> </span> 
                      <span class="editor-delete text-white btn btn-sm"> <i class="bi bi-trash2-fill"></i></span> 
                    </div>
                  </div>
                  <div class="profile-overview px-2">
                    <div class="d-flex mb-2">
                      <div class="d-flex">
                        <div class="label w-30">區塊:</div>
                        <div class="mx-3">${d.block}</div>
                      </div>
                      <div class="d-flex">
                        <div class="label w-30">樓層:</div>
                        <div class="mx-3">${d.floor}</div>
                      </div>
                    </div>
                    <div class="d-flex mb-2">
                      <div class="label w-30">車格號(${grids.length}):</div>
                      <div class="">${grid == '' ?'無':grid}</div>
                    </div>
                    <div class="d-flex">
                      <div class="label w-30">已抽中-ID(${grideds.length}):</div>
                      <div class="">${grided == '' ?'無':grided}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          },
          className:'accordion-item p-0'
        },
      ]
    };

    const NewItemID = ()=>{ const g = () => {return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1)}; return g()+g()+g() };
    
    const card_Template = (id,title) => `
    <div class="card" id="card_Template">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="card-title mt-2">${title}</h3>
          <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-sm text-white editor-upload mx-1" @click.prevent="uploadModal_open">上傳</button>
            <button type="button" class="btn btn-sm text-white editor-create">新增</button>
          </div>
        </div>
        <table id="${id}" class="dataTable py-2" style="width: 100%;"></table>
      </div>
      <div v-if="uploadModal_modal">
        <div class="modal fade show" tabindex="-1" aria-modal="true" role="dialog" style="display: block;">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">上傳視窗</h5>
                <button type="button" class="btn-close" @click.prevent="uploadModal_close" ></button>
              </div>
              <div class="modal-body"> <input class="form-control" type="file" id="uploadFile" accept=".xlsx"> </div>
              <div class="modal-footer py-1 pb-2"> <button type="button" class="btn btn-primary" @click.prevent="uploadModal_upload">上傳</button> </div>
            </div>
          </div>
        </div>
        <div class="modal-backdrop fade show"></div>
      </div>
    </div>
    `;

    const dataTableCode = (dataName,cont)=>{
      const d = localStorage.getItem(dataName);
      const db = d !== null ? JSON.parse(d): [];
      const table = $('#datatables_block').DataTable({ data: db,pageLength:10,lengthChange:false, columns: cont.columns, language: datatables_Language,createdRow:(r)=> $(r).addClass('card my-2 p-0')});

      $(table.table().header()).remove();
      $(table.table().body()).attr('id','accordionBody');
      $(table.table().body()).addClass('accordion');
      // table.data().sort((a,b)=>{
      //    ? a.DT_RowId - b.DT_RowId:parseInt(a.block.replace(/[^0-9]/ig,'')) - parseInt(b.block.replace(/[^0-9]/ig,''))
      // });
      editor = new $.fn.dataTable.Editor( {
        data: db,
        table: "#datatables_block",
        idsrc: cont.idsrc,
        fields: cont.fields
      });

      $('button.editor-create').on('click', function (e) {
        e.preventDefault();
        editor.create( { title: '新增紀錄',formOptions:{main:{initSubmit:false,preSubmit:false}}, buttons: {
          extend:'create',
          text: '確定',
          action: ()=>{
            const obj = [...db,{...editor.get(),DT_RowId:NewItemID()}];
            localStorage.setItem(dataName,JSON.stringify(obj));
            $(".btn-close").trigger('click');
            mainblockCode_table(dataName,cont);
          }
        }}).on('preSubmit',false);
      });

      $('#datatables_block').on('click', '.editor-edit', function (e) {
        e.preventDefault();
        const da = $(this).closest('tr');
        const da_ = table.row(da).data();
        editor.edit( da, { title: '編輯記錄', buttons:{
          extend:'edit',
          text: '確定',
          action:()=> {
            const fil =  db.filter(s => s.DT_RowId !== da_.DT_RowId);
            const obj = [...fil,{...editor.get(),DT_RowId:da_.DT_RowId}];
            localStorage.setItem(dataName,JSON.stringify(obj));
            $(".btn-close").trigger('click');
            mainblockCode_table(dataName,cont);
          }
        }}).on('preSubmit',false);
      });

      $('#datatables_block').on('click', '.editor-delete', function (e) {
        e.preventDefault();
        const da = $(this).closest('tr');
        const da_ = table.row(da).data();
        editor.remove( da, { title: '刪除記錄', message: '您確定要刪除此記錄嗎？', buttons:{
          extend:'remove',
          text: '確定',
          action: ()=> {
            const fil =  db.filter(s => s.DT_RowId !== da_.DT_RowId);
            localStorage.setItem(dataName,JSON.stringify(fil));
            $(".btn-close").trigger('click');
            mainblockCode_table(dataName,cont);
          }
        }}).on('preSubmit',false);
      });
    };
    
    const mainblockCode_table = (dataName,cont)=>{
      $('.section.dashboard').html('');
      $('.section.dashboard').append('<div id="mainblock"></div>');
      new Vue({
        el: "#mainblock",
        template: card_Template('datatables_block',dataName=='residentData'?'住戶資訊':'車位資訊'),
        data: { uploadModal_modal:false },
        mounted:()=> { dataTableCode(dataName,cont) },
        methods:{
          uploadModal_open(){
            this.uploadModal_modal = true 
          },
          uploadModal_close(){
            this.uploadModal_modal = false 
          },
          uploadModal_upload(){
            readExcel('#uploadFile',dataName,cont);
            this.uploadModal_modal = false
          }
        }
      })
    };

    const readExcel = (fileID,dataName,cont)=>{
      const file = $(fileID)[0].files;
      if(file.length == 0){
        alert('尚未選取檔案')
      }else{
        var reader = new FileReader();
        reader.addEventListener("loadend", (evt) => {
          // (B1) GET THE FIRST WORKSHEET
          var workbook = XLSX.read(evt.target.result, {type: "binary"});

          const sheetJson = (sheet)=>{
            worksheet = workbook.Sheets[sheet],
            range = XLSX.utils.decode_range(worksheet["!ref"]);
            // (B2) READ CELLS IN ARRAY

            var data = [];
            var ty = { resident:[ {id:'tobe'}, {id:'name'}, {id:'phone'}, {id:'license'}, {id:'card_num'}, {id:'lattice_num'}, {id:'ambitions'} ], parking:[ {id:'block'}, {id:'floor'}, {id:'grids'} ] };
            for (let row =range.s.r+1; row<=range.e.r; row++) {
              let i = data.length;
              data.push({});
              const aj = (a)=>{var l = ''; if(a != ''){ for(var i = 0 ;i < a.length;i++){l += `${a[i]}${(i+1) == a.length ? '' :','}`}; } return l;}
              for (let col=range.s.c; col<=range.e.c; col++) {
                let cell = worksheet[XLSX.utils.encode_cell({r:row, c:col})];
                data[i][sheet=='住戶名單'? ty.resident[col].id : ty.parking[col].id] = String(cell == undefined ? '': cell.v);
              }
              if(sheet=='車位資訊'){
                data[i]['grideds'] = '';
                data[i]['grids_'] = data[i]['grids'] == '' ? '0' : String([...new Set(data[i]['grids'].split(','))].length);
                data[i]['grids'] = data[i]['grids'] == '' ? '' : aj([...new Set(data[i]['grids'].split(','))])
              };
              if(sheet=='住戶名單'){
                data[i]['lattice_num']='';
                data[i]['lattice_num_'] = '';
                data[i]['ambitions'] = data[i]['ambitions'] == '' ? '' : aj([...new Set(data[i]['ambitions'].split(','))])
              };
              data[i]['DT_RowId']= NewItemID();
            }
            return data
          }
          
          if(dataName){
            const obj = sheetJson(dataName=='residentData' ? '住戶名單':'車位資訊');
            const ol = localStorage.getItem(dataName);
            const newObj = ol == null ? obj : [...JSON.parse(ol),...obj];
            localStorage.setItem(dataName,JSON.stringify(newObj));
            mainblockCode_table(dataName,cont);
          }else{
            for(sheet of workbook.SheetNames){
              if(sheet == '車位資訊' || sheet == '住戶名單'){
                const ol = localStorage.getItem(sheet == '住戶名單' ? 'residentData' :'parkingData');
                const newObj = ol == null ? sheetJson(sheet) : [...JSON.parse(ol),...sheetJson(sheet)];
                localStorage.setItem(sheet == '住戶名單' ? 'residentData' :'parkingData',JSON.stringify(newObj));
                HomeBody_Code();
              }
            }
          }
        });
        reader.readAsArrayBuffer(file[0]);
      }
    };
    // -------------------------------------------- Home clock -------------------------------------------- //

    const HomeConput = {
      filterResident(){ return this.residentData.filter(r=>r.lattice_num == ''); },
      filterParking(){ let n=0 ; for(var i=0;i<this.parkingData.length;i++){ const grid = this.parkingData[i].grids; const grids = grid=='' ? [] : grid.split(','); n+= grids.length; } return n; },
      ParkingSort(){ return this.parkingData.sort((a,b)=> parseInt(a.block.replace(/[^0-9]/ig,'')) - parseInt(b.block.replace(/[^0-9]/ig,''))); }
    }
    
    const clearLocalStorage = ()=>{
      localStorage.clear();
      localStorage.setItem('parkingData',JSON.stringify([])); 
      localStorage.setItem('residentData',JSON.stringify([])); 
      HomeBody_Code();
    }
    
    var HomeDataCont = { startBtn:'開始抽籤' }
    
    const HomeMethods = {
      Home_Upload(){
        readExcel('#HomeUploadFile');
        HomeBody_Code();
      },
      localStorage_Clear(){
        let isExecuted = confirm("確定要清空資料庫？");
        if(isExecuted){ clearLocalStorage(); }
      },
      uploadExampleFile(){
        let isExecuted = confirm("確定要下載範本？");
        if(isExecuted){
          window.location.href = `./excel/uploadExampleFile_1120118.xlsx`;
        }
      },
      exportData(){
        let isExecuted = confirm("確定要下匯出結果？");
        if(isExecuted){
          resident = localStorage.getItem('residentData');
          parking = localStorage.getItem('parkingData');

          if(resident !== null || resident.length != 0){
            const list = JSON.parse(resident);
            const list_ = JSON.parse(parking);

            const map = {DT_RowId:'ID',tobe:"戶別",name:"姓名",phone:"電話", license:"車牌",card_num:"門禁卡號",lattice_num:"車格號(車位)",lattice_num_:'抽籤備註(意願/注)',ambitions:'意願(8個|*請用,隔開)'};
            const map_ = {DT_RowId:'ID',block:"區塊",floor:"樓層",grids_:'剩餘車位(數)',grids:'剩餘車位(車號)', grideds:"抽籤紀錄(*請用,隔開)"};

            const sheet = "抽籤結果";
            const sheet_ = "車位各區明細";
            const d = new Date;
            const filename = `${d.getFullYear()}${d.getMonth()+1}${d.getDate()}${d.getMinutes()}${d.getSeconds()}_${sheet}`;

            exportJsonByMap([{ list:list, map:map, sheet:sheet },{ list:list_, map:map_, sheet:sheet_ }],filename,false);

            clearLocalStorage();
          }
        }
      },
      createToast () {
        parking = localStorage.getItem('parkingData');
        resident = localStorage.getItem('residentData');
        var parking_ = parking === null ? null : JSON.parse(parking);
        var resident_ = resident === null ? null : JSON.parse(resident);

        if((parking_ === null && resident_ === null)||(parking_.length !== 0 && resident_.length !== 0)){
          $('.startSmoke_start').attr('disabled', true);
          HomeBody_Code_.startBtn = '抽籤中';

          resident_ = resident_.sort(()=> 0.5 - Math.random());
          parking_ = parking_.sort((a,b)=> parseInt(a.block.replace(/[^0-9]/ig,'')) - parseInt(b.block.replace(/[^0-9]/ig,'')));
         
          const getTwoNum = (ty)=>{ return ty ? resident_.filter((r, i, a) => a.findIndex(s => r.phone === s.phone ) === i).length :resident_.filter(r=>r.lattice_num === '').length ; }
          let twoNum = getTwoNum(true);
          let ambition_num = 8;

          const runCode = (ty)=>{
            const aj = (a)=>{var l = ''; if(a != ''){ for(var i = 0 ;i < a.length;i++){l += `${a[i]}${(i+1) == a.length ? '' :','}`}; } return l;}
            
            var tp = [
              { type:'one', controller: resident_.filter((r, i, a) =>a.findIndex(s => r.phone === s.phone ) === i) },
              { type:'two', controller: resident_.filter((r) =>r.lattice_num ==='' ) },
              { type:'three', controller: resident_.filter(r=>r.lattice_num === '') }
            ]

            var p = parking_.filter(r=>r.grids !== ''); //車位判斷
            var num_ = 8;
            var li = 0;

            console.log(ty,tp.find(r=>r.type === ty).controller.length)

            if(p.length !== 0){ // 
              for(var p_ = 0 ; p_ < p.length ;p_++){ //車位迴圈
                const b = p[p_].block;
                var g = p[p_].grids == '' ? [] : p[p_].grids.split(','); // 車位數量
                var a = tp.find(r=>r.type === ty).controller; //未登記;
                var gr = g;
                var gred = [];
                var a_ = 0;

                if(g.length !== 0){
                  while (a_ < a.length){
                    var am = a[a_].ambitions == '' ? [] : a[a_].ambitions.split(','); //未登記 意願
                    var tu = 0;
                    if (am.length !== 0 && g.length !== 0 ){
                      for(var i = 0 ; i < num_; i++ ){ //意願迴圈
                        tu = (b === am[i] || ty === 'three') ? ( ty === 'three' ? 1:tu+=1) : 0;
                        if(tu === i+1){
                          li ++;
                          gred = [...gred,a[a_].DT_RowId];
                          var rs = resident_.filter(r=>r.DT_RowId !== a[a_].DT_RowId);
                          var ri = a.find(r=>r.DT_RowId === a[a_].DT_RowId);
                          ri = {...ri,lattice_num:`${b}-${g[0]}`,lattice_num_:`${tu}-${ty === 'three' ? '隨機': ty}`};
                          resident_ = [...rs,ri];
                          a = a.filter(r=>r.DT_RowId !== a[a_].DT_RowId);
                          tp = [
                            { type:'one', controller: a.filter((r, i, a) =>a.findIndex(s => r.phone === s.phone ) === i ) },
                            { type:'two', controller: a.filter(r=>r.lattice_num === '') },
                            { type:'three', controller: a.filter(r=>r.lattice_num === '') }
                          ]
                          var fs = parking_.filter(r => r.DT_RowId !== p[p_].DT_RowId );
                          var fi = p.find(r => r.DT_RowId === p[p_].DT_RowId );
                          gr = gr.filter(r => r !== g[0] );
                          g = gr
                          parking_ = [...fs,{...fi,grids: aj(gr), grideds: aj(gred),grids_:String(gr.length)}];
                          // console.log(ty,li,`${a_+1}/${i+1}`,b,ri.lattice_num,ri.phone,am,g.length,gred.length)
                          localStorage.setItem('residentData',JSON.stringify(resident_));
                          localStorage.setItem('parkingData',JSON.stringify(parking_));
                          HomeBody_Code();

                          a_ = -1;
                        }
                      }  
                    };
                    a_++;
                  }
                }
              }
            }
          }

          runCode('one');
          runCode('two');
          runCode('three');

          // 排序
          var an = resident_.filter(r=>r.lattice_num !== '');
          var an_ = resident_.filter(r=>r.lattice_num === ''); // 未抽到

          an = an.sort((a,b)=> a.lattice_num.split('-')[0].replace(/[^0-9]/ig,'') - b.lattice_num.split('-')[0].replace(/[^0-9]/ig,'') );
          resident_ = [...an,...an_];  
          parking_ = parking_.sort((a,b)=> a.block.replace(/[^0-9]/ig,'') - b.block.replace(/[^0-9]/ig,'') );
          
          // console.log({
          //   resident:resident_,
          //   parking:parking_,
          //   an_:`${an.length}/${an_.length}`,
          // });

          localStorage.setItem('residentData',JSON.stringify(resident_));
          localStorage.setItem('parkingData',JSON.stringify(parking_));
          $('.startSmoke_start').attr('disabled', false);
          HomeBody_Code_.startBtn = '下載結果';
          toastr.info('已完成抽籤程序 可以下載啦!!!','系統提醒!!!');

        }else{
          alert('資料庫是空的！！')
        }
      }
    }

    const HomeBody = ()=>{
      return `
      <div class="row">
        <div class="col-lg-8">
          <div class="row">
            <!-- 住戶資訊 -->
            <div class="col-md-6">
              <div class="card info-card sales-card">
                <div class="card-body">
                  <h5 class="card-title mb-0">住戶資訊</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-card-heading"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{residentData.length}} 人 </h6>
                      <span class="text-success small pt-1 fw-bold">共: 還有 {{ filterResident.length }}</span>
                      <span class="text-muted small pt-2 ps-1">人無車位</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- 車位資訊 -->
            <div class="col-md-6">
              <div class="card info-card revenue-card">
                <div class="card-body">
                  <h5 class="card-title mb-0">車位資訊</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-app-indicator"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{parkingData.length}} 區</h6>
                      <span class="text-success small pt-1 fw-bold">共: 剩餘 {{filterParking}}</span> <span
                        class="text-muted small pt-2 ps-1">車位</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reports -->
            <div class="col-12">
              <div class="card">
                <div class="card-body ">
                  <div class="filter uploadFile_block">
                    <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow" style="width: 30vw;">
                      <div class="dropdown-header text-start text-dark"> <h6>媒體檔上傳</h6> </div>
                      <div class='p-2 px-3'>
                        <input class="form-control" type="file" id="HomeUploadFile" accept=".xlsx">
                        <div class="d-grid gap-2 mt-2">
                          <button class="btn btn-outline-primary text-1" type="button" @click.prevent="Home_Upload" >上傳</button>
                        </div>
                      </div>
                      <div class="dropdown-header text-start text-dark"> <h6>資料庫清空</h6> </div>
                      <div class="d-grid gap-2 pt-1 px-3 ">
                        <button class="btn btn-outline-danger text-1" type="button" @click.prevent="localStorage_Clear" >清空資料庫</button>
                      </div>
                      <div class="dropdown-header text-start text-dark mt-2"> <h6>範本下載</h6> </div>
                      <div class="d-grid gap-2 p-1 px-3 ">
                        <button type="button" class="btn btn-outline-success" @click.prevent="uploadExampleFile" ><i class="bi bi-cloud-download me-1"></i> 範本下載</button>
                      </div>
                      <div class="dropdown-header text-start text-dark mt-2"><h6>結果匯出</h6> </div>
                      <div class="d-grid gap-2 p-1 px-3 ">
                        <button type="button" class="btn btn-outline-secondary" @click.prevent="exportData" ><i class="bi bi-arrow-right-square me-1"></i> 結果匯出</button>
                      </div>
                    </div>
                  </div>

                  <h5 class="card-title mb-0 pb-1">抽籤介面</h5>
                  <div class="text-center">
                    <span class="bi bi-archive-fill d-block" style="color: #012970; font-size: 50px;"></span> 
                    <button  v-if="startBtn === '抽籤中' " type="button" class="btn btn-outline-secondary btn-sm startSmoke_start" >{{startBtn}}...</button>
                    <button  v-if="startBtn === '下載結果' " type="button" class="btn btn-outline-secondary btn-sm startSmoke_start" @click.prevent="exportData" >{{startBtn}}</button>
                    <button  v-if="startBtn === '開始抽籤' " type="button" class="btn btn-outline-secondary btn-sm startSmoke_start" @click.prevent="createToast" >{{startBtn}}</button>
                  </div>
                  
                </div>
              </div>
            </div><!-- End Reports -->

          </div>
        </div>
        <div class="col-lg-4">
          <!-- 車位各區明細 -->
          <div class="card">          
            <div class="card-body">
              <h5 class="card-title mb-0">車位各區明細</h5>
              <div class="activity p-2">
                <div class="activity-item d-flex " v-for="(item,index) in ParkingSort">
                  <div class="activite-label fw-bold text-dark pe-2">{{item.block}} 區 - {{item.floor}} 樓</div>
                  <i class="bi bi-circle-fill activity-badge text-muted align-self-start"></i>
                  <div class="activity-content">剩餘 <span class="fw-bold text-success">{{item.grids == '' ? 0 : item.grids.split(',').length}}</span> 車位</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        `
      }

    const HomeBody_Code = ()=>{
      $('.section.dashboard').html('');
      $('.section.dashboard').append('<div id="mainblock"></div>');
      parking = localStorage.getItem('parkingData');
      resident = localStorage.getItem('residentData');
      HomeBody_Code_ = new Vue({
        el: "#mainblock",
        template: HomeBody(),
        data: { ...HomeDataCont,residentData:JSON.parse(resident), parkingData:JSON.parse(parking)},
        beforeCreate:()=>{
          // var parking = localStorage.getItem('parkingData');
          // var resident = localStorage.getItem('residentData');
          
        },
        mounted:()=> { },
        computed:HomeConput,
        methods:HomeMethods
      })

      parking = parking == null ? [] : JSON.parse(parking);
      resident = resident == null ? [] : JSON.parse(resident);
      
      const fR = ()=>{ return resident.filter(r=>r.lattice_num == '').length; }
      const fP = ()=>{ let n=0 ; for(var i=0;i<parking.length;i++){ const grid = parking[i].grids;const grids = grid=='' ? [] : grid.split(','); n+= grids.length; } return n; }
        
      if(fR() === 0 && fP() === 0){
        HomeBody_Code_.startBtn = '開始抽籤'
      }else if(fR() === 0 ){
        HomeBody_Code_.startBtn = '下載結果'
      }else if(fP() === 0 ){
        HomeBody_Code_.startBtn = '下載結果'
      }else {
        HomeBody_Code_.startBtn = '開始抽籤'
      }
    }
    
    // -------------------------------------------- start clock -------------------------------------------- // 
    var web_block = new Vue({
      el: "#web_block",
      data: {...mt,...HomeDataCont},
      beforeCreate:()=>{
        // localStorage.clear();
        if(parking == null){ localStorage.setItem('parkingData',JSON.stringify([])); }
        if(resident == null ){ localStorage.setItem('residentData',JSON.stringify([])); }
        this.residentData = JSON.parse(resident);
        this.parkingData = JSON.parse(parking);
        
        $('.section.dashboard').append(HomeBody());
      },
      mounted:()=> {
        HomeBody_Code();
      },
      computed: HomeConput,
      methods:{
        clickMenu(name){
          const na = name.split('/');
          this.pageCont = { name:na[0],breadcrumb:name,breadcrumb_:na }
          $('body').removeClass('toggle-sidebar');
          $('.section.dashboard').html('');
          $('.section.dashboard').append('<div id="mainblock"></div>');

          if(this.pageCont.breadcrumb == "Home/Home"){
            HomeBody_Code();
          }else if(this.pageCont.breadcrumb == "Pages/車位資訊"){
            mainblockCode_table('parkingData',parkingCont);
          }else if(this.pageCont.breadcrumb == "Pages/住戶資訊"){
            mainblockCode_table('residentData',residentCont);
          }
        },...HomeMethods
      }
    });

   

    // expor Json
    function exportJson(arr,filename) {
      const wb = XLSX.utils.book_new();
      for (i of arr){
        const ws = XLSX.utils.json_to_sheet(i.data, {...i.header});
        XLSX.utils.book_append_sheet(wb, ws, i.sheet);
      }
      XLSX.writeFile(wb, `${filename}.xlsx`, { bookType: "xlsx" });
    }

    // export Json By Map
    function exportJsonByMap(a,filename,needIdx) {
      for(i of a){
        let headerMap = i.map;
        if (needIdx) { headerMap = { _index: "序号", ...i.map }; }
        i['header'] = Object.values(headerMap);
        i.data = i.list.map((item, idx) => { const ih = ['DT_RowId',...Object.keys(item)];const result = {}; if (needIdx) { result[headerMap._index] = idx + 1; } for (var key of ih) { result[headerMap[key]] = item[key]; } return result;})
      }
      exportJson(a,filename);
    }
  </script>

  <script src="./js/index_main.min.js"></script>
</body>

</html>